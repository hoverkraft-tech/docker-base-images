name: Build Docker images

on:
  workflow_call:
    inputs:
      runs-on:
        description: |
          JSON array of runner(s) to use.
          See https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job.
        type: string
        default: '["ubuntu-latest"]'
        required: false
      oci-registry:
        description: "OCI registry where to pull and push images."
        type: string
        default: "ghcr.io"
        required: false
      platforms:
        description: |
          JSON array of platforms to build images for.
          See https://docs.docker.com/buildx/working-with-buildx/#build-multi-platform-images.
        type: string
        default: '["linux/amd64","linux/arm64"]'
        required: false
    outputs:
      built-images:
        description: |
          Built images data.
          See https://github.com/hoverkraft-tech/ci-github-container/blob/main/.github/workflows/docker-build-images.md#outputs.
        value: ${{ jobs.build-images.outputs.built-images }}
    secrets:
      oci-registry-password:
        description: |
          Password or GitHub token (packages:read and packages:write scopes) used to log against the OCI registry.
          Defaults to GITHUB_TOKEN if not provided.
        required: false

permissions: {}

jobs:
  prepare-images-to-build:
    runs-on: ${{ fromJson(inputs.runs-on) }}
    permissions:
      contents: read
      id-token: write
    outputs:
      images: ${{ steps.set-images-to-build.outputs.images }}
    steps:
      # jscpd:ignore-start
      # FIXME: This is a workaround for having workflow actions. See https://github.com/orgs/community/discussions/38659
      - id: oidc
        uses: ChristopherHX/oidc@73eee1ff03fdfce10eda179f617131532209edbd # v3

      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}
          sparse-checkout: |
            actions
      # jscpd:ignore-end
      - id: get-available-images
        uses: ./self-workflow/actions/get-available-images

      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}
          sparse-checkout: |
            actions

      - id: should-build-images
        uses: ./self-workflow/actions/should-build-images
        with:
          images: ${{ steps.get-available-images.outputs.images }}

      - id: set-images-to-build
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          SHOULD_BUILD_IMAGES: ${{ steps.should-build-images.outputs.should-build-images }}
          PLATFORMS: ${{ inputs.platforms }}
        with:
          script: |
            const shouldBuildImages = JSON.parse(process.env.SHOULD_BUILD_IMAGES);
            const platforms = JSON.parse(process.env.PLATFORMS);

            const buildImages = [];
            for (const [image, shouldBuild] of Object.entries(shouldBuildImages)) {
              if (shouldBuild === true) {
                buildImages.push({
                    name: image,
                    context: `images/${image}`,
                    dockerfile: 'Dockerfile',
                    platforms,
                });
              }
            }
            core.setOutput('images', JSON.stringify(buildImages));

      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        if: always()
        with:
          persist-credentials: false
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}
          sparse-checkout: |
            actions

  build-images:
    needs: prepare-images-to-build
    if: needs.prepare-images-to-build.outputs.images != '[]'
    uses: hoverkraft-tech/ci-github-container/.github/workflows/docker-build-images.yml@0d92511a38c93e30ae0f8b82346116946987a9ca # 0.30.0
    permissions:
      contents: read
      issues: read
      packages: write
      pull-requests: read
      id-token: write
    with:
      oci-registry: ${{ inputs.oci-registry }}
      images: ${{ needs.prepare-images-to-build.outputs.images }}
    secrets:
      oci-registry-password: ${{ secrets.oci-registry-password || secrets.GITHUB_TOKEN || github.token || null }}
