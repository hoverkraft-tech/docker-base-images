---
schemaVersion: "2.0.0"

commandTests:
  - name: "single-source renders helm output with provided deployment id"
    envVars:
      - key: ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID
        value: "4242"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/single-source.sh
    exitCode: 0
    expectedOutput:
      - "name: hoverkraft-deployment"
      - 'deploymentId: "4242"'

  - name: "single-source falls back to unknown deployment id"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/single-source.sh
    exitCode: 0
    expectedOutput:
      - "name: hoverkraft-deployment"
      - "deploymentId: unknown"

  - name: "multi-sources propagates deployment id"
    envVars:
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "7777"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/multi-sources.sh
    exitCode: 0
    expectedOutput:
      - "name: hoverkraft-deployment"
      - 'deploymentId: "7777"'

  - name: "multi-sources defaults deployment id"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/multi-sources.sh
    expectedOutput:
      - "name: hoverkraft-deployment"
      - 'deploymentId: "unknown"'

  - name: "entrypoint executes single-source when ARGOCD_MULTI_SOURCES is 0"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/entrypoint.sh
    envVars:
      - key: "ARGOCD_ENV_ARGOCD_MULTI_SOURCES"
        value: "0"
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "1234"
    expectedOutput:
      - "name: hoverkraft-deployment"
      - 'deploymentId: "1234"'
    expectedError:
      - "hoverkraft-deployment CMP plugin"
      - "single-source application"

  - name: "entrypoint executes multi-sources when ARGOCD_MULTI_SOURCES is 1"
    envVars:
      - key: "ARGOCD_ENV_ARGOCD_MULTI_SOURCES"
        value: "1"
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "5678"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/entrypoint.sh
    expectedOutput:
      - "name: hoverkraft-deployment"
      - 'deploymentId: "5678"'
    expectedError:
      - "hoverkraft-deployment CMP plugin"
      - "multi-sources application"

  - name: "entrypoint defaults to single-source when ARGOCD_MULTI_SOURCES is unset"
    envVars:
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "9999"
      - key: "ARGOCD_APP_NAME"
        value: "test-app"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/entrypoint.sh
    expectedOutput:
      - "name: hoverkraft-deployment"
      - 'deploymentId: "9999"'
    expectedError:
      - "WARN: ARGOCD_MULTI_SOURCES is not set"
      - "single-source application"

  - name: "entrypoint handles invalid ARGOCD_MULTI_SOURCES value"
    command: "bash"
    envVars:
      - key: "ARGOCD_ENV_ARGOCD_MULTI_SOURCES"
        value: "invalid"
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "8888"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/entrypoint.sh
    exitCode: 0
    expectedError:
      - "WARN: ARGOCD_MULTI_SOURCES is invalid"
      - "WARN: defaulting to single source mode"

  - name: "entrypoint with DEBUG enabled shows environment"
    envVars:
      - key: "ARGOCD_ENV_DEBUG"
        value: "true"
      - key: "ARGOCD_ENV_ARGOCD_MULTI_SOURCES"
        value: "0"
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "1111"
    command: "bash"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/entrypoint.sh
    exitCode: 0
    expectedError:
      - '\+ DEBUG: current environment:'
      - "ARGOCD_ENV_DEBUG=true"
      - "ARGOCD_ENV_ARGOCD_MULTI_SOURCES=0"
      - "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID=1111"

  - name: "entrypoint display argocd app name"
    command: "bash"
    envVars:
      - key: "ARGOCD_ENV_ARGOCD_MULTI_SOURCES"
        value: "1"
      - key: "ARGOCD_ENV_HOVERKRAFT_DEPLOYMENT_ID"
        value: "9999"
    args:
      - -c
      - |
        set -euo pipefail
        cd /hk-tools/tests
        /hk-tools/entrypoint.sh
    exitCode: 0
    expectedError:
      - '\+ application: hk-app'

fileExistenceTests:
  - name: "entrypoint script is present"
    path: "/hk-tools/entrypoint.sh"
    shouldExist: true
    isExecutableBy: "any"

  - name: "single-source script is present"
    path: "/hk-tools/single-source.sh"
    shouldExist: true
    isExecutableBy: "any"

  - name: "multi-sources script is present"
    path: "/hk-tools/multi-sources.sh"
    shouldExist: true
    isExecutableBy: "any"

  - name: "kustomize template exists"
    path: "/hk-tools/kustomize-template.yaml"
    shouldExist: true

metadataTest:
  user: "argocd"

# global configuration
globalEnvVars:
  - key: "ARGOCD_APP_NAME"
    value: "hk-app"
  - key: "ARGOCD_APP_NAMESPACE"
    value: "hk-ns"
  - key: "KUBE_VERSION"
    value: "1.33.0"
